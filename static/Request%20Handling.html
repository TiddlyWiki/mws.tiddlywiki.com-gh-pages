<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.4.0-prerelease" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="static.css">
<title>Request Handling: TiddlyWiki MultiWikiServer â€” TiddlyWiki for the People</title>
</head>
<body class="tc-body">
<div><p><div class="tc-static-alert"><div class="tc-static-alert-inner">This page is part of a static HTML representation of the TiddlyWiki at <a class="tc-tiddlylink-external" href="https://mws.tiddlywiki.com/" rel="noopener noreferrer" target="_blank">https://mws.tiddlywiki.com/</a></div></div>
</p></div>
<section class="tc-story-river tc-static-story-river">
<div><p><div class="tc-tiddler-frame tc-tiddler-view-frame tc-tiddler-exists  tc-tagged-Architecture" data-tags="Architecture" data-tiddler-title="Request Handling" role="article"><div class="tc-tiddler-title tc-clearfix"><div class="tc-titlebar"><span class="tc-tiddler-controls"><button aria-expanded="false" aria-label="more" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fmore-tiddler-actions" title="More actions"></button><span class="tc-reveal" hidden="true"></span><button aria-label="Edit this tiddler" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fedit" title="Edit this tiddler"></button><button aria-label="close" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fclose" title="Close this tiddler"></button></span><span><h2 class="tc-title">Request Handling</h2></span></div><div class="tc-tiddler-info tc-popup-handle tc-reveal" hidden="true"></div></div><div class="tc-reveal"></div><div class="tc-reveal"><div class="tc-subtitle tc-clearfix">13th June 2025 at 1:22am</div></div><div class="tc-reveal"><div class="tc-tags-wrapper"><span class="tc-tag-list-item" data-tag-title="Architecture"><span aria-expanded="false" class="tc-tag-label tc-btn-invisible" draggable="true" style="color:<<cssvar foreground>>;"><span class="tc-tag-exists">Architecture</span></span><span class="tc-drop-down tc-reveal" hidden="true"></span></span></div></div><div class="tc-tiddler-body tc-clearfix tc-reveal"><div class="markdown">
<ol>
<li>
<p><strong>Entry Point</strong>: <code class="_codified_">Router.handle()</code>
</p>
<ul>
<li>Takes HTTP/HTTP2 request and response objects</li>
<li>Wraps <code class="_codified_">handleRequest()</code> in error handling</li>
</ul>
</li>
<li>
<p><strong>Main Request Processing</strong>: <code class="_codified_">Router.handleRequest()</code>
</p>
<ul>
<li>Emit middleware event</li>
<li>Apply Helmet middleware</li>
<li>Create Streamer instance</li>
<li>Call <code class="_codified_">handleStreamer()</code></li>
</ul>
</li>
<li>
<p><strong>Stream Processing</strong>: <code class="_codified_">Router.handleStreamer()</code>
</p>
<ul>
<li>Emits streamer event</li>
<li>Finds matching route using <code class="_codified_">findRoute()</code></li>
<li>Performs security checks (CSRF protection)</li>
<li>Processes request body based on <code class="_codified_">bodyFormat</code></li>
<li>Creates <code class="_codified_">ServerRequest</code> instance</li>
<li>Calls <code class="_codified_">handleRoute()</code></li>
</ul>
</li>
<li>
<p><strong>Route Matching</strong>: <code class="_codified_">Router.findRoute()</code> and <code class="_codified_">findRouteRecursive()</code>
</p>
<ul>
<li>Recursively matches URL path against defined routes</li>
<li>Handles nested routes</li>
<li>Matches HTTP methods</li>
<li>Returns array of matched route segments</li>
</ul>
</li>
<li>
<p><strong>Route Handling</strong>: <code class="_codified_">Router.handleRoute()</code>
</p>
<ul>
<li>Executes handlers for matched routes in sequence</li>
<li>Emits handle event</li>
<li>Falls back to 404 if no handler sends response</li>
</ul>
</li>
</ol>
<h2>Body Format Processing</h2>
<p>The router supports multiple body formats:
</p>
<ul>
<li><code class="_codified_">stream</code>: Raw streaming data</li>
<li><code class="_codified_">string</code>: UTF-8 string</li>
<li><code class="_codified_">json</code>: Parsed JSON data</li>
<li><code class="_codified_">buffer</code>: Raw buffer</li>
<li><code class="_codified_">www-form-urlencoded</code>: Parsed form data as object</li>
<li><code class="_codified_">www-form-urlencoded-urlsearchparams</code>: Form data as URLSearchParams</li>
<li><code class="_codified_">ignore</code>: Ignores request body (default for GET/HEAD)</li>
</ul>
<h2>Security Features</h2>
<ul>
<li>Built-in Helmet middleware for security headers</li>
<li>CSRF protection via <code class="_codified_">x-requested-with</code> header checks</li>
<li>JSON security parsing (protects against prototype pollution)</li>
<li>Method matching validation</li>
<li>Path validation</li>
</ul>
<p>The routes are hierarchical, allowing for nested routes with inherited properties and progressive URL path matching.
</p>
<p>It is important that the entire request path be awaited and eventually resolve or reject. A promise should never be left hanging. The Router class takes care of making sure every request has finished with some response, but if the promise never resolves or rejects, the request will eventually time out.
</p>
</div></div>
</div></p></div>
</section>
</body>
</html>

